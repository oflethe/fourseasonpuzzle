<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>å››å­£åˆåˆæ‹¼åœ–çµ±è¨ˆè¡¨</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

  <style>
    /* é‡‘å¡åº•è‰²ï¼ˆæ•´æ ¼ï¼‰ */
    .gold-cell { background-color: #fff8dc !important; }

    /* å·²å‹¾é¸ï¼ˆéé‡‘å¡ï¼‰ç°åº• */
    .checked-cell { background-color: #aec1df !important; }

    /* é‡‘3/4/5 å­—è‰²ï¼ˆç”¨åœ¨çµæœè¡¨æ ¼å…§çš„æ•¸å­—ï¼‰ */
    .gold3 { color:#d4af37; font-weight:700; }
    .gold4 { color:#ff5733; font-weight:700; }
    .gold5 { color:#0d6efd;  font-weight:700; }

    /* çµæœè¡¨æ ¼æ¨£å¼å¾®èª¿ */
    #result table th, #result table td { vertical-align: middle; }
    .cell-tight { letter-spacing: 1px; }
    .tag-ok { display:inline-block; padding:.2rem .5rem; border-radius:.25rem; background:#e9ecef; }
    
    /* å¤šå¡æç¤ºï¼šç´…è‰²é‚Šæ¡† + ç´…è‰²æ•¸å­— */
    .checked-multi { border: 2px solid #dc3545 !important; }
    .qty.multi { color: #dc3545; font-weight: 700; }

    /* é‡‘å¡æç¤ºï¼šé‡‘è‰²å¤–æ¡† (æ¯”å¤šå¡ç´…é‚Šå„ªå…ˆ) */
    .gold-hint { box-shadow: 0 0 0 3px #d4af37 inset; } 
    .gold-border { box-shadow: 0 0 0 3px #d4af37 inset; }
   /* é‡‘å¡æç¤ºï¼šé‡‘è‰²å…§æ¡†ï¼ˆä»»ä½•ç‹€æ…‹éƒ½é¡¯ç¤ºã€èˆ‡ç´…é‚Š/ç°åº•ä¸è¡çªï¼‰ */
   #cardTable td.gold-hint { position: relative; }
   #cardTable td.gold-hint::after {
     content: "";
     position: absolute;
     inset: 2px;                 /* å…§ç¸® 2pxï¼Œé¿å…è¢«è¡¨æ ¼é‚Šç·šè“‹ä½ */
     border: 2px solid #d4af37;  /* é‡‘è‰²æ¡† */
     border-radius: 4px;         /* åœ“è§’å¯ä¾å–œå¥½èª¿æ•´ */
     pointer-events: none;       /* ä¸æ“‹é»æ“Š */
     z-index: 1;                 /* è“‹åœ¨å…§å®¹ä¸Šæ–¹ */
}

/* åŒ¯å‡ºåœ–ç‰‡æ™‚è®“çµæœè¡¨æ ¼æ¡†ç·šæ›´ç²—æ›´é»‘ */
.export-compact #resultTable {
  border: 1px solid #000 !important;
}

.export-compact #resultTable th,
.export-compact #resultTable td {
  border: 1px solid #000 !important;
}


    /* æ‰‹æ©Ÿå‹å–„å°ºå¯¸ */
    @media (max-width: 768px) {
      .colName { min-width: 160px !important; }
      #cardTable input.qty { width: 72px !important; }
      #cardTable .form-check-input { width: 22px; height: 22px; }
      .table-responsive { overflow-x: auto; }
    }

    /* å›ºå®šè¡¨é ­èˆ‡å·¦å´åˆ—è™Ÿï¼ˆstickyï¼‰ */
    #cardTable thead th { position: sticky; top: 0; z-index: 2; background: #cfe2ff; }
    #cardTable thead th:first-child,
    #cardTable tbody td:first-child {
      position: sticky; left: 0; background: #fff; z-index: 3;
    }

    /* è®“æ•´æ ¼å¥½é»æ“Š */
    .cell-hit { cursor: pointer; padding: .2rem; }
    .touch-gap { gap: .6rem !important; }
  </style>
</head>
<body class="bg-light">
<div class="container py-4">

  <h1 class="mb-4">å››å­£åˆåˆæ‹¼åœ–çµ±è¨ˆè¡¨</h1>

  <!-- è¡¨æ ¼ -->
  <div class="table-responsive">
    <table class="table table-bordered align-middle text-center" id="cardTable">
      <thead class="table-primary">
        <tr>
          <th>#</th>
          <!-- æ¬„ä½æ¨™é¡Œå‹•æ…‹ç”Ÿæˆ -->
        </tr>
      </thead>
      <tbody>
        <!-- 1~9 åˆ—å‹•æ…‹ç”Ÿæˆ -->
      </tbody>
    </table>
  </div>
<div class="row">
  <h3 class="mt-4">ç»“æœ</h3>
  <label class="small">
    <input type="checkbox" id="showQtyToggle"> æ˜¾ç¤ºå¤šå¡æ•°é‡
  </label></div>
  <span id="todayBadge" class="mt-3 col-sm-12 ms-2 d-flex justify-content-end fw-bold"></span>
  <div id="result" class="p-3 bg-white border rounded col-md-auto col-sm-12"></div>

  <div class="mt-3 d-flex flex-wrap gap-2 mb-5">
    <button class="btn btn-primary" onclick="copyResult()">è¤‡è£½ç»“æœ</button>
    <button class="btn btn-outline-dark" onclick="downloadImage()">ä¸‹è½½å›¾ç‰‡</button>
    <button class="btn btn-outline-primary" onclick="downloadResult()">ä¸‹è½½ .txt</button>
    <button class="btn btn-outline-success" onclick="exportState()">æ±‡å‡ºçŠ¶æ€</button>
    <button class="btn btn-outline-warning" onclick="importState()">æ±‡å…¥çŠ¶æ€</button>
    <button class="btn btn-secondary" onclick="resetAll()">é‡è®¾ï¼ˆä¸æ¸…è®°å¿†ï¼‰</button>
    <button class="btn btn-outline-secondary" onclick="clearMemory()">æ¸…ç©ºè®°å¿†</button>
  </div>

</div>

<!-- ç¼ºçš„ ä¹å®®æ ¼ Modal -->
<div class="modal fade" id="missModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">é€‰æ‹©ç¼ºçš„å·ç </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body text-center">
        <div id="missGrid" class="d-grid" style="grid-template-columns: repeat(3, 1fr); gap:10px;">
          <!-- ä¹å®®æ ¼æŒ‰éˆ•å‹•æ…‹ç”Ÿæˆ -->
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button>
        <button type="button" class="btn btn-primary" id="applyMissBtn">å¥—ç”¨</button>
      </div>
    </div>
  </div>
</div>

<!-- Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

<script>
// ---------------- è¨­å®š ----------------
const cols = 15;
const rows = 9;
const STORAGE_KEY = 'szhh-cards-v1';

// é‡‘å¡å®šç¾©
const gold3 = [[8,8],[9,6],[10,6],[11,4],[12,4],[13,3]];
const gold4 = [[14,6],[13,7],[12,7],[11,7],[10,8]];
const gold5 = [[15,8],[15,9],[14,9],[13,9],[12,9]];

// ---------------- å»ºè¡¨ ----------------
const table = document.getElementById("cardTable");
const theadRow = table.querySelector("thead tr");
const tbody = table.querySelector("tbody");

// æ¬„ä½æ¨™é¡Œåç¨±ï¼ˆå›ºå®šæ¸…å–®ï¼‰
const colTitles = [
  "è¶èˆçº·é£", "æ¼«æ­¥å–·æ³‰", "å“èŒ—åˆå", "ç†æ”¿ä¹‹æ—¶", "çª¥æ¢ä¹‹é•œ",
  "é£’çˆ½éª‘é©¬", "åå®´è½»ç›ˆ", "å® çˆ±çŠ¬å½±", "é™è¯»æ—¶å…‰", "æŒ‡å°–ç´å£°",
  "ç”»ç¬”ç”Ÿè¾‰", "èˆæ­¥è½»ç›ˆ", "æ‰¹é˜…å…¸ç±", "æš®äº‘ä»°æœ›", "å¤œå¼¹å¿ƒå¼¦"
];


// å»ºç«‹æ¬„ä½æ¨™é¡Œï¼ˆåŠ ä¸Šå…¨/æ¸…/ç¼ºï¼‰
for (let c=1;c<=cols;c++){
  const th=document.createElement("th");
  th.innerHTML = `
    <div class="d-flex flex-column align-items-center">
      <span class="text-muted small">${c}</span>
      <input type="text" class="form-control form-control-sm text-center colName"
             value="${colTitles[c-1]||"æ¬„"+c}" data-col="${c}" style="min-width:110px">
      <div class="btn-group btn-group-sm mt-1" role="group">
        <button type="button" class="btn btn-primary q-all"  data-col="${c}">å…¨</button>
        <button type="button" class="btn btn-danger q-none" data-col="${c}">æ¸…</button>
        <button type="button" class="btn btn-light q-miss" data-col="${c}">ç¼º</button>
        <button type="button" class="btn btn-outline-danger q-zero" data-col="${c}">é›¶</button>
      </div>
    </div>`;
  theadRow.appendChild(th);
}

// ç”¢ç”Ÿ 1~9 åˆ—
for (let r=1;r<=rows;r++){
  const tr=document.createElement("tr");
  const idx=document.createElement("td");
  idx.textContent=r;
  tr.appendChild(idx);
  for (let c=1;c<=cols;c++){
    const td=document.createElement("td");

    const isGold =
      gold3.some(([cc,rr])=>cc===c && rr===r) ||
      gold4.some(([cc,rr])=>cc===c && rr===r) ||
      gold5.some(([cc,rr])=>cc===c && rr===r);
    if (isGold) td.classList.add("gold-cell");

    td.innerHTML=`
      <div class="d-flex justify-content-center align-items-center touch-gap">
        <input type="checkbox" class="form-check-input chk">
        <input type="number" class="form-control form-control-sm qty" min="0" inputmode="numeric" style="width:60px">
      </div>`;
    td.classList.add('cell-hit');
    tr.appendChild(td);
  }
  tbody.appendChild(tr);
}

// æ•´æ ¼é»æ“Šåˆ‡æ›ï¼ˆä¸è‡ªå‹•å¡«æ•¸é‡ï¼‰
tbody.addEventListener('click', (e) => {
  const td = e.target.closest('td');
  if (!td) return;
  const chk = td.querySelector('.chk');
  const qty = td.querySelector('.qty');
  if (!chk || !qty) return;
  if (e.target === chk || e.target === qty) return;
  chk.checked = !chk.checked;
  calculate();
  refreshCheckedStyles();
  saveStateDebounced();
});

// ---------------- å·¥å…· ----------------
function goldClass(col, row){
  const pos = [col, row];
  if (gold5.some(([c,r])=>c===pos[0]&&r===pos[1])) return 'gold5';
  if (gold4.some(([c,r])=>c===pos[0]&&r===pos[1])) return 'gold4';
  if (gold3.some(([c,r])=>c===pos[0]&&r===pos[1])) return 'gold3';
  return '';
}
function setColumnChecked(colIdx, checked, qtyVal = '') {
  for (let r=0; r<rows; r++){
    const cell = tbody.rows[r].cells[colIdx];
    const chk  = cell.querySelector('.chk');
    const qty  = cell.querySelector('.qty');
    chk.checked = !!checked;
    qty.value   = checked ? qtyVal : '';
  }
}
function setColumnMissing(colIdx, missArr) {
  setColumnChecked(colIdx, true, '');
  missArr.forEach(n=>{
    const rowNo = Number(n);
    if (rowNo>=1 && rowNo<=rows){
      const cell = tbody.rows[rowNo-1].cells[colIdx];
      const chk  = cell.querySelector('.chk');
      const qty  = cell.querySelector('.qty');
      chk.checked = false;
      qty.value = '';
    }
  });
}

function refreshCheckedStyles(){
  for (let r=0; r<rows; r++){
    for (let c=1; c<=cols; c++){
      const cell = tbody.rows[r].cells[c];
      const chk  = cell.querySelector('.chk');
      const qty  = cell.querySelector('.qty');
      if (!cell || !chk || !qty) continue;

      // æ¸…é™¤èˆŠ class
      cell.classList.remove('checked-cell','checked-multi','gold-hint');
      qty.classList.remove('multi');

      if (chk.checked){
        cell.classList.add('checked-cell');   // ç°åº•
        if (qty.value && Number(qty.value) >= 1){
          cell.classList.add('checked-multi'); // ç´…é‚Š
          qty.classList.add('multi');          // ç´…å­—
        }
      }

      // é‡‘å¡æ ¼å­ â†’ é¡å¤–åŠ é‡‘è‰²æç¤ºï¼Œä¸ç®¡æœ‰æ²’æœ‰å‹¾é¸ã€å¤šå¡
      const isGold =
        gold3.some(([cc,rr])=>cc===c && rr===r+1) ||
        gold4.some(([cc,rr])=>cc===c && rr===r+1) ||
        gold5.some(([cc,rr])=>cc===c && rr===r+1);
      if (isGold){
        cell.classList.add('gold-hint');
      }
    }
  }
}


// ---------------- ä¹å®®æ ¼ç¼ºçš„ ----------------
let currentMissCol = null;
let selectedMiss = new Set();
function buildMissGrid(){
  const grid = document.getElementById("missGrid");
  grid.innerHTML = "";
  for (let i=1;i<=9;i++){
    const btn = document.createElement("button");
    btn.type="button";
    btn.className="btn btn-outline-dark";
    btn.textContent=i;
    btn.dataset.num=i;
    btn.addEventListener("click",()=>{
      if (selectedMiss.has(i)){
        selectedMiss.delete(i);
        btn.classList.remove("btn-danger");
        btn.classList.add("btn-outline-dark");
      } else {
        selectedMiss.add(i);
        btn.classList.add("btn-danger");
        btn.classList.remove("btn-outline-dark");
      }
    });
    grid.appendChild(btn);
  }
}
function openMissModal(col){
  currentMissCol = col;
  selectedMiss.clear();
  buildMissGrid();
  const modal = new bootstrap.Modal(document.getElementById("missModal"));
  modal.show();
}
document.getElementById("applyMissBtn").addEventListener("click",()=>{
  if (!currentMissCol) return;
  setColumnMissing(currentMissCol, Array.from(selectedMiss));
  calculate();
  refreshCheckedStyles();
  saveStateDebounced();
  bootstrap.Modal.getInstance(document.getElementById("missModal")).hide();
});

// ---------------- è¡¨é ­å¿«é€Ÿéµ ----------------
// è¡¨é ­å¿«é€Ÿéµ
theadRow.addEventListener('click', (e)=>{
  const btn = e.target.closest('button');
  if (!btn) return;
  const col = Number(btn.dataset.col);
  if (!col) return;

  if (btn.classList.contains('q-all')) {
    setColumnChecked(col, true, '');
  } else if (btn.classList.contains('q-none')) {
    setColumnChecked(col, false, '');
  } else if (btn.classList.contains('q-miss')) {
    openMissModal(col);
  } else if (btn.classList.contains('q-zero')) {
    zeroColumnExtras(col);                // â† æ¥ä¸Šé€™è¡Œ
  }

  calculate();
  refreshCheckedStyles();
  saveStateDebounced();
});


// ---------------- è¨ˆç®— ----------------
function calculate(){
  const colNames = document.querySelectorAll(".colName");
  const showQty = document.getElementById("showQtyToggle")?.checked;

  // é‡‘å¡ ç¼º/å¤š çµ±è¨ˆ
  let gold3Missing = 0, gold4Missing = 0, gold5Missing = 0;
  let gold3Multi = 0,   gold4Multi = 0,   gold5Multi = 0;

  // ğŸ”¹ æ‹¼åœ–ç¸½ç¼ºã€å¤š çµ±è¨ˆ
  let totalMissing = 0;
  let totalMulti   = 0;

  let html = `
    <div class="table-responsive">
      <table id="resultTable" class="table table-sm table-bordered border border-2 border-dark text-center align-middle">
        <thead class="table-secondary">
          <tr>
            <th style="width:36%;" class="bg-warning">#ï¼åç¨±</th>
            <th style="width:32%;" class="bg-danger">ç¼ºçš„</th>
            <th style="width:32%;">å¤šçš„</th>
          </tr>
        </thead>
        <tbody>
  `;

  for (let c=0;c<cols;c++){
    let lackParts=[], multiParts=[];
    let lackCount = 0; // ğŸ”¹ è¨ˆç®—ç¼ºå¹¾å¼µ

    for (let r=0;r<rows;r++){
      const cell=tbody.rows[r].cells[c+1];
      const chk=cell.querySelector(".chk").checked;
      const qtyVal=cell.querySelector(".qty").value;
      const qty = qtyVal === "" ? "" : Number(qtyVal);
      const rowNo = r+1;
      const cls = goldClass(c+1, rowNo);

      if (!chk) {
        lackParts.push(cls ? `<span class="${cls}">${rowNo}</span>` : String(rowNo));
        lackCount++;
        totalMissing++; // ğŸ”¹ ç¸½ç¼ºæ•¸ç´¯åŠ 

        // é‡‘å¡ç¼ºæ•¸
        const pos = [c+1, rowNo];
        if (gold3.some(([cc,rr])=>cc===pos[0] && rr===pos[1])) gold3Missing++;
        if (gold4.some(([cc,rr])=>cc===pos[0] && rr===pos[1])) gold4Missing++;
        if (gold5.some(([cc,rr])=>cc===pos[0] && rr===pos[1])) gold5Missing++;
      } else {
        if (qty !== "" && qty >= 1){
          const label = showQty ? `${rowNo}(Ã—${qty})` : `${rowNo}`;
          multiParts.push(cls ? `<span class="${cls}">${label}</span>` : label);
          totalMulti += showQty ? qty : 1; // ğŸ”¹ ç¸½å¤šæ•¸ç´¯åŠ 

          if (showQty){
            const pos = [c+1, rowNo];
            if (gold3.some(([cc,rr])=>cc===pos[0] && rr===pos[1])) gold3Multi += qty;
            if (gold4.some(([cc,rr])=>cc===pos[0] && rr===pos[1])) gold4Multi += qty;
            if (gold5.some(([cc,rr])=>cc===pos[0] && rr===pos[1])) gold5Multi += qty;
          }
        }
      }
    }

    const colName = colNames[c].value || `æ¬„${c+1}`;
    const lackText  = lackParts.length
        ? `${lackParts.join('')} `
        : `<span class="tag-ok bg-danger text-white fw-bold">é½Š</span>`;
    const multiText = multiParts.length ? multiParts.join('') : '';

    html += `
      <tr>
        <td class="text-start bg-warning-subtle">
          <span class="text-muted">${String(c+1).padStart(2,'0')}.</span> ${colName}
        </td>
        <td class="cell-tight">${lackText}</td>
        <td class="cell-tight">${multiText}</td>
      </tr>
    `;
  }

  // ğŸ”¹ é‡‘å¡çµ±è¨ˆè¡Œ
  html += `
      <tr class="table-warning fw-bold">
        <td colspan="3" class="text-start">
          é‡‘3 ç¼º ${gold3Missing}${showQty ? `ã€€å¤š ${gold3Multi}` : ``}
          ã€€|ã€€é‡‘4 ç¼º ${gold4Missing}${showQty ? `ã€€å¤š ${gold4Multi}` : ``}
          ã€€|ã€€é‡‘5 ç¼º ${gold5Missing}${showQty ? `ã€€å¤š ${gold5Multi}` : ``}
        </td>
      </tr>
  `;

  // ğŸ”¹ æ‹¼åœ–ç¸½è¨ˆè¡Œ
  html += `
      <tr class="table-info fw-bold">
        <td colspan="3" class="text-start">
          æ‹¼åœ–ç¸½è¨ˆï¼šç¼º ${totalMissing}${showQty ? `ã€€å¤š ${totalMulti}` : ``}
          ã€€|ã€€é‡‘å¡ç¸½è¨ˆï¼šç¼º ${gold3Missing + gold4Missing + gold5Missing}
          ã€€${showQty ? `ã€€å¤š ${gold3Multi + gold4Multi + gold5Multi}` : ``}
          ã€€|ã€€é‡‘5 ç¸½è¨ˆï¼šç¼º ${gold5Missing}${showQty ? `ã€€å¤š ${gold5Multi}` : ``}
        </td>
      </tr>
    </tbody></table></div>
  `;

  document.getElementById("result").innerHTML = html;
  refreshCheckedStyles();
}


// å°‡æŸæ¬„ä½ã€Œå·²å‹¾é¸ä¸” qty>=1ã€çš„æ ¼å­ï¼Œæ•¸é‡ä¸€éµæ­¸ 0
function zeroColumnExtras(colIdx){
  for (let r=0; r<rows; r++){
    const cell = tbody.rows[r].cells[colIdx];
    const chk  = cell.querySelector('.chk');
    const qty  = cell.querySelector('.qty');
    if (chk.checked && qty.value && Number(qty.value) >= 1){
      qty.value = 0; // æ­¸ 0 = ä¸ç®—å¤šå¡ï¼Œä½†ä»æ˜¯ã€Œå·²æœ‰ã€
    }
  }
}


// ---------------- åŒ¯å‡ºçµæœ ----------------
function getPlainResultText(){
  const tbl = document.getElementById("resultTable");
  if(!tbl) return "";
  const lines = [];
  lines.push("#ï¼åç¨±\tç¼ºçš„\tå¤šçš„");
  const bodyRows = tbl.tBodies[0]?.rows || [];
  for (let i=0;i<bodyRows.length;i++){
    const row = bodyRows[i];
    const nameCell = row.cells[0].innerText.trim();
    const lackCell = row.cells[1].innerText.trim();
    const multiCell= row.cells[2].innerText.trim();
    lines.push(`${nameCell}\t${lackCell||""}\t${multiCell||""}`);
  }
  return lines.join("\n");
}
async function copyResult(){
  const text = getPlainResultText();
  if (!text){ alert("ç›®å‰æ²’æœ‰å¯è¤‡è£½çš„å…§å®¹ã€‚"); return; }
  try{
    await navigator.clipboard.writeText(text);
    alert("å·²è¤‡è£½çµæœåˆ°å‰ªè²¼ç°¿ï¼");
  }catch(e){
    const ta = document.createElement("textarea");
    ta.value = text; document.body.appendChild(ta);
    ta.select(); document.execCommand("copy");
    document.body.removeChild(ta);
    alert("å·²è¤‡è£½çµæœåˆ°å‰ªè²¼ç°¿ï¼");
  }
}

function downloadImage() {
  const target = document.getElementById("result"); // åªåŒ¯å‡ºçµæœè¡¨æ ¼
  if (!target) return;

  // 1) å¥—ä¸Šç·Šç¸®æ¨£å¼ + å¼·åŒ–æ¡†ç·š
  document.body.classList.add('export-compact');

  // 2) ç”Ÿæˆè¼ƒé«˜è§£æåº¦çš„åœ–ç‰‡ï¼ˆscale=2ï¼‰
  html2canvas(target, {
    scale: 2,
    backgroundColor: '#ffffff' // ç™½åº•ï¼ˆé¿å…é€æ˜ï¼‰
  }).then(canvas => {
    // 3) è¨­å®šæª”åï¼šseasonpuzzle-yyMMdd.png
    const now = new Date();
    const yy = String(now.getFullYear()).slice(-2);
    const mm = String(now.getMonth() + 1).padStart(2, '0');
    const dd = String(now.getDate()).padStart(2, '0');
    const filename = `seasonpuzzle-${yy}${mm}${dd}.png`;

    const link = document.createElement("a");
    link.download = filename;
    link.href = canvas.toDataURL("image/png");
    link.click();
  }).finally(() => {
    // 4) ç§»é™¤ç·Šç¸®æ¨£å¼ï¼Œæ¢å¾©åŸç‹€
    document.body.classList.remove('export-compact');
  });
}



function downloadResult(){
  const text = getPlainResultText();
  if (!text){ alert("ç›®å‰æ²’æœ‰å¯ä¸‹è¼‰çš„å…§å®¹ã€‚"); return; }
  const blob = new Blob([text], {type: "text/plain;charset=utf-8"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  const now = new Date();
  const pad = n => String(n).padStart(2,"0");
  const filename = `cards_result_${now.getFullYear()}${pad(now.getMonth()+1)}${pad(now.getDate())}_${pad(now.getHours())}${pad(now.getMinutes())}${pad(now.getSeconds())}.txt`;
  a.href = url; a.download = filename;
  document.body.appendChild(a); a.click();
  document.body.removeChild(a); URL.revokeObjectURL(url);
}

// ---------------- è¨˜æ†¶ ----------------
function snapshotState(){
  const names = Array.from(document.querySelectorAll('.colName')).map(i => i.value);
  const cells = [];
  for (let r=0; r<rows; r++){
    const row = [];
    for (let c=0; c<cols; c++){
      const cell = tbody.rows[r].cells[c+1];
      const chk = cell.querySelector('.chk').checked;
      const qty = cell.querySelector('.qty').value;
      row.push({ chk, qty });
    }
    cells.push(row);
  }
  return { names, cells };
}
function applyState(state){
  if (state?.names?.length === cols){
    document.querySelectorAll('.colName').forEach((el, i) => el.value = state.names[i] ?? el.value);
  }
  if (Array.isArray(state?.cells) && state.cells.length === rows){
    for (let r=0; r<rows; r++){
      for (let c=0; c<cols; c++){
        const cell = tbody.rows[r].cells[c+1];
        const chk = cell.querySelector('.chk');
        const qty = cell.querySelector('.qty');
        const v = state.cells[r][c] || {};
        chk.checked = !!v.chk;
        qty.value = (v.qty ?? '');
      }
    }
  }
  calculate();
  refreshCheckedStyles();
}
let saveTimer = null;
function saveStateDebounced(){
  clearTimeout(saveTimer);
  saveTimer = setTimeout(() => {
    try {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(snapshotState()));
    } catch(e) {}
  }, 200);
}
function loadState(){
  try{
    const raw = localStorage.getItem(STORAGE_KEY);
    if (!raw) return false;
    const state = JSON.parse(raw);
    applyState(state);
    return true;
  }catch(e){ return false; }
}
function clearMemory(){
  localStorage.removeItem(STORAGE_KEY);
  alert('å·²æ¸…ç©ºè¨˜æ†¶ã€‚');
}
function exportState(){
  const text = JSON.stringify(snapshotState());
  navigator.clipboard.writeText(text).then(()=>{ alert("å·²è¤‡è£½ç‹€æ…‹åˆ°å‰ªè²¼ç°¿ï¼"); })
    .catch(()=>{ alert("ç„¡æ³•å­˜å–å‰ªè²¼ç°¿ï¼Œè«‹æ‰‹å‹•è¤‡è£½ã€‚"); });
}
function importState(){
  const text = prompt("è«‹è²¼ä¸Šä¹‹å‰åŒ¯å‡ºçš„ç‹€æ…‹æ–‡å­—ï¼ˆJSONï¼‰ï¼š");
  if (!text) return;
  try {
    const state = JSON.parse(text);
    applyState(state);
    saveStateDebounced();
    alert("å·²å¥—ç”¨åŒ¯å…¥ç‹€æ…‹ï¼");
  } catch(e){
    alert("æ ¼å¼éŒ¯èª¤ï¼Œè«‹ç¢ºèªè²¼ä¸Šçš„å…§å®¹ã€‚");
  }
}
// ...existing code...

// é¡¯ç¤ºä»Šæ—¥æ—¥æœŸ badge
function showTodayBadge() {
  const now = new Date();
  const yyyy = now.getFullYear();
  const mm = String(now.getMonth() + 1).padStart(2, '0');
  const dd = String(now.getDate()).padStart(2, '0');
  document.getElementById("todayBadge").textContent = `æ—¥æœŸï¼š${yyyy}-${mm}-${dd}`;
}
showTodayBadge();


function snapshotState(){
  const names = Array.from(document.querySelectorAll('.colName')).map(i => i.value);
  const cells = [];
  for (let r=0; r<rows; r++){
    const row = [];
    for (let c=0; c<cols; c++){
      const cell = tbody.rows[r].cells[c+1];
      const chk = cell.querySelector('.chk').checked;
      const qty = cell.querySelector('.qty').value;
      row.push({ chk, qty });
    }
    cells.push(row);
  }
  // æ–°å¢ showQtyToggle ç‹€æ…‹
  const showQty = document.getElementById("showQtyToggle")?.checked ?? false;
  return { names, cells, showQty };
}

function applyState(state){
  if (state?.names?.length === cols){
    document.querySelectorAll('.colName').forEach((el, i) => el.value = state.names[i] ?? el.value);
  }
  if (Array.isArray(state?.cells) && state.cells.length === rows){
    for (let r=0; r<rows; r++){
      for (let c=0; c<cols; c++){
        const cell = tbody.rows[r].cells[c+1];
        const chk = cell.querySelector('.chk');
        const qty = cell.querySelector('.qty');
        const v = state.cells[r][c] || {};
        chk.checked = !!v.chk;
        qty.value = (v.qty ?? '');
      }
    }
  }
  // é‚„åŸ showQtyToggle ç‹€æ…‹
  if (typeof state?.showQty === "boolean") {
    document.getElementById("showQtyToggle").checked = state.showQty;
  }
  calculate();
  refreshCheckedStyles();
}

// ...existing code...

// ---------------- ç¶å®šäº‹ä»¶èˆ‡åˆå§‹åŒ– ----------------
function bindEvents(){
  document.querySelectorAll(".chk,.qty,.colName").forEach(el=>{
    el.addEventListener("input", () => { calculate(); refreshCheckedStyles(); saveStateDebounced(); });
    el.addEventListener("change", () => { calculate(); refreshCheckedStyles(); saveStateDebounced(); });
  });
}
function resetAll(){
  document.querySelectorAll(".chk").forEach(el=>el.checked=false);
  document.querySelectorAll(".qty").forEach(el=>el.value="");
  calculate();
  refreshCheckedStyles();
  saveStateDebounced();
}
bindEvents();
document.getElementById("showQtyToggle")?.addEventListener("change", calculate);
if (!loadState()) { calculate(); }
</script>

</body>
</html>
